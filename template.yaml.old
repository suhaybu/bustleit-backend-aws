AWSTemplateFormatVersion: "2010-09-09"
Transform: AWS::Serverless-2016-10-31
Description: >
  bustleit-backend-serverless

# More info about Globals: https://github.com/awslabs/serverless-application-model/blob/master/docs/globals.rst
Globals:
  Function:
    Timeout: 5 # Increased from 3 to 5 seconds
    MemorySize: 128
    Runtime: provided.al2023
    Architectures:
      - arm64

Resources:
  BustleitFunction: # Changed from HelloWorldFunction to BustleitFunction
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: rust-cargolambda
    Properties:
      CodeUri: ./rust_app
      Handler: bootstrap
      Events:
        # Auth routes
        AuthLogin:
          Type: Api
          Properties:
            Path: /auth/login
            Method: post

        # AI routes
        AiUserData:
          Type: Api
          Properties:
            Path: /ai/request/userdata
            Method: post
        AiAllUsers:
          Type: Api
          Properties:
            Path: /ai/request/allusers
            Method: get
        AiClusteredUsers:
          Type: Api
          Properties:
            Path: /ai/request/clusteredUsers
            Method: get
        AiSchedules:
          Type: Api
          Properties:
            Path: /ai/request/schedules
            Method: post
        AiTasks:
          Type: Api
          Properties:
            Path: /ai/request/tasks
            Method: get
        AiTaskedUsers:
          Type: Api
          Properties:
            Path: /ai/request/taskedUsers
            Method: get

        # Recommend routes
        RecommendPost:
          Type: Api
          Properties:
            Path: /recommend
            Method: post

        RecommendTest:
          Type: Api
          Properties:
            Path: /recommend/test
            Method: get

        # Health check
        HealthCheck:
          Type: Api
          Properties:
            Path: /health
            Method: get

Outputs:
  BustleitApi: # Changed from HelloWorldApi
    Description: "API Gateway endpoint URL for Prod stage"
    Value: !Sub "https://${ServerlessRestApi}.execute-api.${AWS::Region}.amazonaws.com/Prod/"
  BustleitFunction: # Changed from HelloWorldFunction
    Description: "Lambda Function ARN"
    Value: !GetAtt BustleitFunction.Arn
  BustleitFunctionIamRole: # Changed from HelloWorldFunctionIamRole
    Description: "Implicit IAM Role created for Bustleit function"
    Value: !GetAtt BustleitFunctionRole.Arn
